# 列车系统使用说明

## 🚂 系统功能

这个系统实现了通过UDP信号控制列车创建和颜色配置的功能：

1. **UDP信号解析** - 解析特定格式的列车信号
2. **列车创建** - 根据信号创建对应的列车
3. **材质颜色映射** - 对指定材质的Mesh进行颜色配置
4. **数量控制** - 最多30个列车，超出时自动替换最早的

## 📡 UDP信号格式

### 列车信号格式
```
{model1;D1:W}
```

**格式说明：**
- `{` 和 `}` - 信号开始和结束标记
- `model1` - 列车模型名称
- `;` - 分隔符
- `D1` - 区域标识（对应材质名称）
- `:` - 颜色分隔符
- `W` - 颜色代码

### 示例信号
```
{model1;D1:W}    // 创建model1列车，D1区域使用W颜色
{train2;D2:R}    // 创建train2列车，D2区域使用R颜色
{express;D1:B}   // 创建express列车，D1区域使用B颜色
```

## 🎨 颜色代码映射

系统支持以下颜色代码：

| 颜色代码 | 颜色名称 | 说明 |
|---------|---------|------|
| R       | 红色     | Red |
| G       | 绿色     | Green |
| B       | 蓝色     | Blue |
| Y       | 黄色     | Yellow |
| W       | 白色     | White |
| K       | 黑色     | Black |
| C       | 青色     | Cyan |
| M       | 洋红     | Magenta |

## 🔧 系统配置

### 1. TrainManager配置

在Inspector中设置：
- `trainPrefab` - 列车预制体
- `colorMappings` - 颜色映射列表
- `usePresetColors` - 是否使用预设颜色

### 2. 材质配置

确保列车预制体中的Mesh使用正确的材质：
- 需要变色的Mesh应使用D1材质
- 材质名称应包含区域标识（如D1、D2等）
- 材质应支持颜色属性

### 3. 着色器要求

D1材质应使用支持以下属性的着色器：
- `_Color` - 主颜色
- `_TintIntensity` - 色调强度
- `_Roughness` - 粗糙度

## 🚀 工作流程

### 1. 信号接收
```
UDP接收 → 信号验证 → 格式解析 → 数据提取
```

### 2. 列车创建
```
检查数量限制 → 创建列车实例 → 命名 → 添加到管理列表
```

### 3. 颜色应用
```
查找匹配材质 → 应用颜色配置 → 更新材质属性 → 完成配置
```

### 4. 数量管理
```
监控活跃列车 → 超出限制时 → 移除最旧列车 → 释放资源
```

## 📊 列车管理

### 数量限制
- **最大数量**: 30个列车
- **超出处理**: 自动移除最旧的列车
- **内存管理**: 自动释放被移除列车的资源

### 命名规则
```
Train_{模型名}_{区域}_{颜色}_{时间戳}
```
示例：`Train_model1_D1_W_143022`

### 生命周期
1. **创建** - 根据UDP信号创建
2. **配置** - 应用颜色和材质
3. **管理** - 添加到活跃列表
4. **移除** - 超出数量限制时自动移除

## 🐛 常见问题解决

### 1. 列车不创建
- 检查UDP信号格式是否正确
- 确认TrainManager组件已设置
- 验证trainPrefab是否正确配置

### 2. 颜色不显示
- 检查材质名称是否包含区域标识
- 确认着色器支持颜色属性
- 验证颜色代码是否在映射中定义

### 3. 数量限制不生效
- 检查activeTrains列表管理
- 确认RemoveOldestTrain方法正确调用
- 验证列车销毁逻辑

## 🔍 调试功能

### UDPManager调试按钮
- **检查场景设置** - 验证所有组件状态
- **发送测试列车信号** - 测试列车创建功能
- **发送测试涂鸦文件名** - 测试涂鸦功能

### 日志信息
系统会输出详细的日志信息：
- UDP信号接收和解析
- 列车创建过程
- 颜色应用状态
- 数量管理情况

## 📁 文件结构

```
Assets/Scripts/
├── UDPManager.cs          # UDP通信和信号处理
├── TrainManager.cs        # 列车管理和颜色配置
├── CanvasController.cs    # Canvas控制
└── GraffitiManager.cs     # 涂鸦管理
```

## ⚠️ 注意事项

1. **信号格式** - 必须严格按照 `{model;area:color}` 格式
2. **材质命名** - 材质名称必须包含区域标识
3. **颜色代码** - 使用预定义的颜色代码
4. **数量限制** - 最多30个列车，超出自动替换
5. **性能考虑** - 大量列车可能影响性能

## 🎮 测试步骤

1. 确保场景中有TrainManager组件
2. 配置列车预制体和材质
3. 运行Unity场景
4. 使用UDP工具发送测试信号：`{model1;D1:W}`
5. 观察列车是否正确创建和显示颜色
6. 检查Console日志确认系统状态

## 📞 技术支持

如果遇到问题，请检查：
1. Console日志输出
2. 组件配置状态
3. 材质和着色器设置
4. UDP信号格式
5. 列车数量限制


